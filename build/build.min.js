const path=require("path");const fs=require("fs");const js_compiler=require(path.join(process.argv[2],"npm/node_modules/uglify-es"));const sass_compiler=require(path.join(process.argv[2],"npm/node_modules/sass"));const dir=path.join(__dirname,"../components");const newline=require("os").EOL;process.chdir(dir);let output_js=`/*${newline}`+` * Dynamic Suite: Users${newline}`+` * License: GPLv3${newline}`+` */${newline}`;let output_css="";let files=fs.readdirSync(dir);for(const file of files){let data=fs.readFileSync(path.join(dir,file)).toString();if(!data.includes("<template>")||!data.includes("</template>")){console.log(`File ${file} missing template`);process.exit(1)}let template=data.substring(data.lastIndexOf("<template>")+10,data.lastIndexOf("</template>"));let name=file.substring(0,file.length-4).replace(/([A-Z])/g,"-$1").toLowerCase().substr(1);let component=`Vue.component("users-${name}", {`;template=template.trim().replace(/<\!--.*?-->/g,"").replace(/>\s+</g,"><").replace(" />","/>").replace(/(\r\n|\n|\r)/gm,"").replace(/\s\s+/g," ").replace(/>\s+/g,">").replace(/\s>+/g,">").replace(/\s<+/g,"<").replace(/<\s+/g,"<");component+="template: `"+template+"`";if(data.includes("<script>")&&data.includes("<\/script>")){let script=data.substring(data.lastIndexOf("<script>")+8,data.lastIndexOf("<\/script>"));script=script.trim().replace("export default {","");let pos=script.lastIndexOf("}");script=script.substring(0,pos)+script.substring(pos+1);script=script.trim();component+=`,${script}`}component+="});";let ugly_js=js_compiler.minify(component);if(typeof ugly_js.error!=="undefined"){console.log(ugly_js.error);process.exit(1)}else{output_js+=`${ugly_js.code}${newline}`}if(data.includes('<style lang="sass">')&&data.includes("</style>")){let sass=data.substring(data.lastIndexOf('<style lang="sass">')+19,data.lastIndexOf("</style>"));output_css+=sass}}output_js+='if(document.getElementById("users-component-view")){new Vue({el:"#users-component-view"});};';let ugly_css=sass_compiler.renderSync({data:output_css,indentedSyntax:true,outputStyle:"compressed"});output_css=`/*${newline}`+` * Dynamic Suite: Users${newline}`+` * License: GPLv3${newline}`+` */${newline}`+ugly_css.css.toString();fs.writeFileSync(path.normalize("../client/js/users.min.js"),output_js);fs.writeFileSync(path.normalize("../client/css/users.min.css"),output_css);